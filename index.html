<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Checklist CE – Rapport texte</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --bg:#f6f7fb; --paper:#fff; --ink:#111827; --muted:#6b7280;
      --brand:#0ea5e9; --accent:#60a5fa; --border:#e5e7eb; --shadow:0 8px 24px rgba(0,0,0,.08);
      --ok:#059669; --warn:#f59e0b; --bad:#e11d48;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1220; --paper:#0f172a; --ink:#e5e7eb; --muted:#9ca3af; --border:#1f2937; --shadow:0 8px 24px rgba(0,0,0,.35); --accent:#38bdf8; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:36px; height:36px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--accent)); box-shadow:var(--shadow)}
    h1{font-size:18px; margin:0}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    button{border:1px solid var(--border); background:var(--paper); color:var(--ink); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow:var(--shadow); min-height:44px}
    button.primary{background:var(--brand); color:#fff; border-color:transparent}
    button:active{transform:translateY(1px)}
    .layout{display:grid; grid-template-columns:1fr; gap:16px}
    @media (min-width:1020px){ .layout{grid-template-columns:1.15fr 0.85fr} }
    .card{background:var(--paper); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px}
    .card h2{margin:6px 0 12px; font-size:18px}
    .grid{display:grid; gap:8px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .tiny{font-size:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    select,input[type="text"],textarea{width:100%; min-height:44px; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:transparent; color:inherit}
    textarea.report{width:100%; min-height:360px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .template-bar{display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap; margin:6px 0 8px}
    .template-bar > div{display:flex; gap:8px; align-items:center}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .spacer{flex:1}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--paper)}

    /* Tree / nodes */
    .tree{display:block}
    .node{display:flex; align-items:center; gap:8px; padding:8px; border:1px solid var(--border); border-radius:12px; background:var(--paper); margin:6px 0}
    .node .lbl{flex:1; min-width:140px}
    .node .tools{display:flex; gap:6px; flex-wrap:wrap}
    .children{margin-left:18px; border-left:2px dashed var(--border); padding-left:10px}
    .node .idx{color:var(--muted); font-size:12px; min-width:36px; text-align:right}
    .drag-handle{cursor:grab; user-select:none;}
    .drag-over{outline:2px dashed var(--accent)}

    .status-chip{font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* iOS: éviter zoom au focus */
    @supports (-webkit-touch-callout: none){ input, select, textarea, button{ font-size:16px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Checklist CE – Rapport texte (SAP FSM)</h1>
      </div>
      <div class="toolbar">
        <button id="copyBtn" class="primary" type="button">Copier le rapport</button>
        <button id="resetBtn" type="button" title="Réinitialiser">Réinitialiser</button>
        <button id="exportBtn" type="button" title="Exporter modèles (.json)">Exporter modèles</button>
        <label class="pill" for="importFile" title="Importer modèles (.json)">Importer <input id="importFile" type="file" accept="application/json" style="display:none"></label>
      </div>
    </header>

    <div class="layout">
      <!-- Editeur -->
      <section class="card">
        <h2>Éditeur de checklist (blocs)</h2>
        <div class="template-bar">
          <div>
            <label for="filter">Filtrer</label>
            <input id="filter" type="text" placeholder="Rechercher un modèle…" style="width:220px">
          </div>
          <div>
            <label for="templateSel">Modèle</label>
            <select id="templateSel"></select>
          </div>
          <div>
            <button id="applyTpl" type="button" title="Remplace la checklist">Appliquer (remplacer)</button>
            <button id="appendTpl" type="button" title="Ajoute les items du modèle">Ajouter à la suite</button>
          </div>
          <div class="spacer"></div>
          <div class="pill">
            <label for="tplName">Nom du modèle</label>
            <input id="tplName" type="text" placeholder="ex. TX710 – Pack préventif" style="width:220px">
            <select id="tplType" title="Type">
              <option value="Standard">Standard</option>
              <option value="R">R – Thermoformeuse</option>
              <option value="T">T – Operculeuse</option>
              <option value="B">B – Machine à cloche</option>
              <option value="Autre">Autre</option>
            </select>
            <button id="saveTpl" type="button" title="Sauver comme modèle">Sauver modèle</button>
            <button id="deleteTpl" type="button" title="Supprimer le modèle">Supprimer modèle</button>
          </div>
        </div>

        <div class="tiny">Astuce : utilise <strong>Sous‑bloc</strong>, <strong>Dupliquer</strong>, <strong>↑/↓</strong>, <strong>→/←</strong> ou <strong>glisser‑déposer</strong> (poignée ≡) pour organiser. Case à cocher + statut pour chaque bloc.</div>

        <div id="tree" class="tree" aria-live="polite"></div>

        <div class="row" style="margin-top:10px">
          <span class="tiny">Total: <span id="cntAll">0</span> • <span class="ok">OK <span id="cntOk">0</span></span> • <span class="warn">À surveiller <span id="cntWarn">0</span></span> • <span class="bad">À corriger <span id="cntBad">0</span></span></span>
          <div class="spacer"></div>
          <button id="expandAll" type="button">Tout déplier</button>
          <button id="collapseAll" type="button">Tout replier</button>
        </div>
      </section>

      <!-- Rapport texte -->
      <section class="card">
        <h2>Rapport (texte brut)</h2>
        <textarea id="reportOut" class="report" readonly></textarea>
        <div class="row" style="margin-top:8px">
          <div id="counter" class="tiny">0 caractères</div>
          <div class="spacer"></div>
          <div class="tiny">Copier puis coller dans SAP FSM.</div>
        </div>

        <h3 style="margin-top:18px">Pièces remplacées</h3>
        <textarea id="parts" placeholder="Référence – Désignation – Qté (une par ligne)"></textarea>
        <div class="tiny">Cette section est incluse en fin de rapport.</div>

        <h3 style="margin-top:18px">Sync GitHub (optionnel)</h3>
        <div class="grid cols-2">
          <div><label for="ghUser">Utilisateur/Org</label><input id="ghUser" type="text" placeholder="ex. nitroks14"></div>
          <div><label for="ghRepo">Repo</label><input id="ghRepo" type="text" placeholder="ex. Check-list-CE"></div>
          <div><label for="ghBranch">Branche</label><input id="ghBranch" type="text" value="main"></div>
          <div><label for="ghPath">Chemin fichier</label><input id="ghPath" type="text" value="templates.json"></div>
          <div><label for="ghToken">GitHub Token (PAT)</label><input id="ghToken" type="text" placeholder="ghp_... (non stocké tant que tu n'actives pas l'option)"></div>
          <div><label><input id="rememberPat" type="checkbox"> Mémoriser le token (local)</label></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="pushGh" type="button" title="Écrit templates.json dans ton repo">Pousser modèles → GitHub</button>
          <button id="pullGh" type="button" title="Lit templates.json depuis ton repo">← Récupérer depuis GitHub</button>
          <span class="tiny muted">Nécessite un PAT avec scope <code>repo</code>. CORS autorisé côté GitHub. Le token reste local.</span>
        </div>
      </section>
    </div>
  </div>

  <textarea id="scratch" style="position:absolute; left:-9999px; top:-9999px; opacity:0" aria-hidden="true"></textarea>

<script>
// =========================
// Utilitaires & persistance
// =========================
const STORAGE = { state:"ce_state_v2", templates:"ce_templates_v2", pat:"ce_pat_v1" };
function uid(){ return Math.random().toString(36).slice(2,9); }
function esc(s){ return (s??"").toString().replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }
function lines(s){ return (s||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean); }
function clone(x){ return structuredClone(x); }

// Node factory
function n(label, checked=false, level="OK", children=[]){ return { id:uid(), label, checked, level, children }; }

// =========================
// Modèles (défaut)
// =========================
const DEFAULT_TEMPLATES = [
  { id:"tpl_standard", name:"Standard (générique)", type:"Standard", items:[
    n("Contrôle visuel général / capots / sécurité",true,"OK"),
    n("Niveaux & lubrification (pompes, réducteurs)",true,"OK"),
    n("Circuit vide : pompes / filtres / étanchéité",true,"OK"),
    n("Pneumatique : filtres / fuites / pression",true,"OK"),
    n("Électrique : connexions / capteurs / câbles",true,"OK"),
    n("Mises à jour / sauvegardes paramètres",false,"À surveiller"),
    n("Hygiène / nettoyage zones produit",true,"OK"),
    n("Outils de coupe / chauffage / scellage",true,"À surveiller"),
    n("Essais de sécurité (arrêt d’urgence, barrières)",true,"OK"),
    n("Essais de production & validation",true,"OK")
  ]},
  { id:"tpl_R", name:"R – Thermoformeuse", type:"R", items:[
    n("Station de formage",true,"OK",[
      n("Réseau de vide",true,"OK",[
        n("Révision vannes de vide",true,"OK"),
        n("Tuyaux",true,"OK",[ n("Remplacement",false,"OK"), n("Contrôle",true,"OK") ])
      ]),
      n("Remplacement des joints de 3,2 mm",false,"OK"),
      n("Remplacement des joints de socle",false,"OK"),
      n("Remplacement des joints du bloc de connections",true,"OK"),
      n("Remplacement des couteaux de vide et gaz",false,"OK"),
      n("Réglage en hauteur",true,"OK",[
        n("Remplacement des roulements",false,"OK"),
        n("Remplacement des joints",false,"OK"),
        n("Remplacement des vis sans fin",false,"OK"),
        n("Remplacement de la chaîne",false,"OK")
      ])
    ]),
    n("Station de scellage (plaque, surface, température, pression)",true,"OK"),
    n("Avance chaîne / pinces (alignement, lubrification)",true,"OK"),
    n("Coupe longitudinale & transversale (lames, alignement)",true,"À surveiller"),
    n("Vide / gaz (pompes, filtres, fuites, MAP)",true,"OK"),
    n("Air comprimé (pression, filtre, fuites)",true,"OK"),
    n("Refroidissement eau (débit, température)",true,"OK"),
    n("Évacuation des chutes / propreté machine",true,"OK"),
    n("Sécurité & capotages (arrêt d’urgence, inter-verrouillages)",true,"OK"),
    n("Marquage / impression (si présent)",false,"À surveiller"),
    n("Essai production & validation du scellage",true,"OK")
  ]},
  { id:"tpl_T", name:"T – Operculeuse", type:"T", items:[
    n("Convoyeur d’entrée / alignement barquettes",true,"OK"),
    n("Transport barquettes / poussoirs / centrage",true,"OK"),
    n("Outil / plateau de scellage (planéité, état, chauffe)",true,"OK"),
    n("Scellage (température/pression/temps)",true,"OK"),
    n("Vide / gaz (MAP) / fuite",true,"OK"),
    n("Déroulage film (frein, alignement, danseur)",true,"OK"),
    n("Détection capteurs / cellules / sécurité",true,"OK"),
    n("Hygiène & nettoyage zone produit",true,"OK"),
    n("Étiquetage / marquage (si présent)",false,"À surveiller"),
    n("Essai production & qualité de scellage",true,"OK")
  ]},
  { id:"tpl_B", name:"B – Machine à cloche", type:"B", items:[
    n("Joints de couvercle/chambre (état, propreté)",true,"OK"),
    n("Barres de soudure / téflon / fils résistifs",true,"OK"),
    n("Pompe à vide (niveau d’huile, filtre, bruit)",true,"OK"),
    n("Cycle de test (vide, maintien, soudure)",true,"OK"),
    n("Couvercle / charnières / vérins",true,"OK"),
    n("Convoyeur/ceinture (alignement, tension) – si présent",false,"À surveiller"),
    n("Électricité & câbles (usure, connexions)",true,"OK"),
    n("Sécurité (inter-verrouillage, arrêts)",true,"OK"),
    n("Hygiène / nettoyage",true,"OK")
  ]},
  { id:"tpl_TX710", name:"TX710 – Modèle dédié", type:"T", items:[
    n("Révision des vannes de vide",true,"OK"),
    n("Contrôle & remplacement joints outillage 1V2R",true,"OK"),
    n("Remplacement des joints du bloc de connections",true,"OK"),
    n("Test de vide : atteindre 10 mbar, étanchéité reprise 10 mbar",true,"OK"),
    n("Essais avec film & barquettes",true,"OK")
  ]}
];

function loadTemplates(){
  try{ const raw = localStorage.getItem(STORAGE.templates); if(!raw){ localStorage.setItem(STORAGE.templates, JSON.stringify(DEFAULT_TEMPLATES)); return clone(DEFAULT_TEMPLATES);} const arr = JSON.parse(raw); return Array.isArray(arr)&&arr.length?arr:clone(DEFAULT_TEMPLATES);}catch(e){return clone(DEFAULT_TEMPLATES)}
}
function saveTemplates(arr){ try{ localStorage.setItem(STORAGE.templates, JSON.stringify(arr)); }catch(e){} }

function loadState(){
  try{ const raw = localStorage.getItem(STORAGE.state); if(!raw) return { parts:"", lastTpl:"tpl_standard", tree: clone(DEFAULT_TEMPLATES[0].items) }; const s = JSON.parse(raw); return { parts:s.parts||"", lastTpl:s.lastTpl||"tpl_standard", tree:Array.isArray(s.tree)?s.tree:clone(DEFAULT_TEMPLATES[0].items) }; }catch(e){ return { parts:"", lastTpl:"tpl_standard", tree: clone(DEFAULT_TEMPLATES[0].items) } }
}
function saveState(){ try{ localStorage.setItem(STORAGE.state, JSON.stringify({ parts: state.parts, lastTpl: state.lastTpl, tree })); }catch(e){} }

let lib = loadTemplates();
let state = loadState();
let tree = state.tree;

// =========================
// UI modèles
// =========================
const sel = document.getElementById('templateSel');
const filter = document.getElementById('filter');
const tplName = document.getElementById('tplName');
const tplType = document.getElementById('tplType');

function refreshTemplateSelect(){
  const q = (filter.value||"").toLowerCase();
  sel.innerHTML = '';
  const byType = {};
  lib.forEach(t=>{ if(q && !(`${t.name} ${t.type}`.toLowerCase().includes(q))) return; (byType[t.type]=byType[t.type]||[]).push(t); });
  Object.keys(byType).sort().forEach(type=>{
    const grp = document.createElement('optgroup'); grp.label = type;
    byType[type].forEach(t=>{ const opt = document.createElement('option'); opt.value=t.id; opt.textContent=t.name; grp.appendChild(opt); });
    sel.appendChild(grp);
  });
  const exists = lib.find(t=>t.id===state.lastTpl);
  sel.value = exists?state.lastTpl:(sel.options[0]?.value||"");
}
filter.addEventListener('input', refreshTemplateSelect);

function applyTemplate(replace=true){
  const id = sel.value; const tpl = lib.find(t=>t.id===id); if(!tpl) return;
  if(replace){ if(!confirm(`Remplacer la checklist actuelle par le modèle “${tpl.name}” ?`)) return; tree = clone(tpl.items); }
  else { tree = [...tree, ...clone(tpl.items)]; }
  state.lastTpl = id; saveState(); renderTree();
}
function saveTemplate(){
  const name = tplName.value.trim(); const type = tplType.value||'Standard';
  if(!name){ alert('Donne un nom au modèle.'); return; }
  const id = 'tpl_'+uid(); lib.push({ id, name, type, items: clone(tree) }); saveTemplates(lib);
  tplName.value=''; tplType.value=type; refreshTemplateSelect(); sel.value = id; state.lastTpl=id; saveState();
}
function deleteTemplate(){
  const id = sel.value; const t = lib.find(x=>x.id===id); if(!t){ alert('Aucun modèle sélectionné.'); return; }
  if(!confirm(`Supprimer le modèle “${t.name}” ?`)) return; lib = lib.filter(x=>x.id!==id); saveTemplates(lib); state.lastTpl = lib[0]?.id || 'tpl_standard'; saveState(); refreshTemplateSelect();
}

// =========================
// Arbre / blocs (incl. DnD)
// =========================
const elTree = document.getElementById('tree');
let dragSrcId = null; // id du node en déplacement

function renderTree(){
  elTree.innerHTML = '';
  tree.forEach((node, idx)=> elTree.appendChild(renderNode(node, null, idx)));
  updateCounters();
  renderText();
}

function renderNode(node, parent, idx){
  const wrap = document.createElement('div'); wrap.className='node'; wrap.dataset.id=node.id; wrap.draggable=true;

  // Drag events
  wrap.addEventListener('dragstart', (e)=>{ dragSrcId = node.id; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', node.id); wrap.classList.add('dragging'); });
  wrap.addEventListener('dragend', ()=>{ dragSrcId=null; wrap.classList.remove('dragging'); document.querySelectorAll('.drag-over').forEach(x=>x.classList.remove('drag-over')); });
  wrap.addEventListener('dragover', (e)=>{ e.preventDefault(); wrap.classList.add('drag-over'); e.dataTransfer.dropEffect='move'; });
  wrap.addEventListener('dragleave', ()=> wrap.classList.remove('drag-over'));
  wrap.addEventListener('drop', (e)=>{ e.preventDefault(); wrap.classList.remove('drag-over'); const srcId = e.dataTransfer.getData('text/plain'); if(!srcId||srcId===node.id) return; moveNodeBefore(srcId, node.id); saveState(); renderTree(); });

  const handle = document.createElement('span'); handle.textContent = '≡'; handle.className='drag-handle'; handle.title='Glisser pour déplacer';
  handle.addEventListener('mousedown', e=>{ e.stopPropagation(); });

  const ck = document.createElement('input'); ck.type='checkbox'; ck.checked=!!node.checked; ck.addEventListener('change', ()=>{ node.checked = ck.checked; saveState(); renderText(); updateCounters(); });

  const lbl = document.createElement('input'); lbl.className='lbl'; lbl.type='text'; lbl.value=node.label||''; lbl.addEventListener('input', ()=>{ node.label = lbl.value; saveState(); renderText(); });

  const sel = document.createElement('select'); ['OK','À surveiller','À corriger'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; if(node.level===v) o.selected=true; sel.appendChild(o); }); sel.addEventListener('change', ()=>{ node.level=sel.value; saveState(); renderText(); updateCounters(); });

  const idxSpan = document.createElement('div'); idxSpan.className='idx'; idxSpan.textContent = '#'+(idx+1);

  const tools = document.createElement('div'); tools.className='tools';
  tools.append(
    makeBtn('Frère +', ()=> addSibling(node,parent)),
    makeBtn('Sous-bloc', ()=> addChild(node)),
    makeBtn('⧉', ()=> duplicateNode(node,parent), 'Dupliquer'),
    makeBtn('↑', ()=> moveUp(node,parent)),
    makeBtn('↓', ()=> moveDown(node,parent)),
    makeBtn('→', ()=> indentNode(node,parent)),
    makeBtn('←', ()=> outdentNode(node,parent)),
    makeBtn('🗑️', ()=> deleteNode(node,parent), 'Supprimer')
  );

  wrap.append(handle, ck, lbl, sel, idxSpan, tools);

  if(node.children && node.children.length){
    const ch = document.createElement('div'); ch.className='children'; ch.dataset.collapsed='0';
    node.children.forEach((c,i)=> ch.appendChild(renderNode(c,node,i)));
    wrap.appendChild(ch);
  }
  return wrap;
}

function makeBtn(txt, fn, title=""){ const b=document.createElement('button'); b.type='button'; b.textContent=txt; if(title) b.title=title; b.addEventListener('click',()=>{ fn(); saveState(); renderTree(); }); return b; }

// === opérations ===
function findLoc(id, nodes=tree, parent=null){
  for(let i=0;i<nodes.length;i++){ const nd=nodes[i]; if(nd.id===id) return {parent, nodes, index:i}; if(nd.children?.length){ const r=findLoc(id, nd.children, nd); if(r) return r; } }
  return null;
}
function addSibling(node,parent){ const loc=findLoc(node.id); if(!loc) return; loc.nodes.splice(loc.index+1,0,n('Nouveau bloc',false,'OK',[])); }
function addChild(node){ node.children=node.children||[]; node.children.push(n('Sous-bloc',false,'OK',[])); }
function duplicateNode(node,parent){ const loc=findLoc(node.id); if(!loc) return; const copy=clone(node); regenerateIds(copy); loc.nodes.splice(loc.index+1,0,copy); }
function regenerateIds(nd){ nd.id=uid(); (nd.children||[]).forEach(regenerateIds); }
function deleteNode(node,parent){ const loc=findLoc(node.id); if(!loc) return; loc.nodes.splice(loc.index,1); }
function moveUp(node,parent){ const loc=findLoc(node.id); if(!loc||loc.index===0) return; [loc.nodes[loc.index-1],loc.nodes[loc.index]]=[loc.nodes[loc.index],loc.nodes[loc.index-1]]; }
function moveDown(node,parent){ const loc=findLoc(node.id); if(!loc||loc.index>=loc.nodes.length-1) return; [loc.nodes[loc.index+1],loc.nodes[loc.index]]=[loc.nodes[loc.index],loc.nodes[loc.index+1]]; }
function indentNode(node,parent){ const loc=findLoc(node.id); if(!loc||loc.index===0) return; const prev=loc.nodes[loc.index-1]; prev.children=prev.children||[]; loc.nodes.splice(loc.index,1); prev.children.push(node); }
function outdentNode(node,parent){ const loc=findLoc(node.id); if(!loc||!loc.parent) return; const parentLoc=findLoc(loc.parent.id); if(!parentLoc) return; loc.nodes.splice(loc.index,1); parentLoc.nodes.splice(parentLoc.index+1,0,node); }

// DnD avant un autre node
function moveNodeBefore(srcId, destId){
  const src=findLoc(srcId); const dest=findLoc(destId); if(!src||!dest) return;
  const node = src.nodes.splice(src.index,1)[0];
  // même parent -> recalcul index si déplacement vers après
  let insertIndex = dest.index; if(src.nodes===dest.nodes && src.index<dest.index) insertIndex = dest.index-1;
  dest.nodes.splice(insertIndex,0,node);
}

// Expand/Collapse
function collapseAll(){ document.querySelectorAll('.children').forEach(c=>{ c.style.display='none'; c.dataset.collapsed='1'; }); }
function expandAll(){ document.querySelectorAll('.children').forEach(c=>{ c.style.display='block'; c.dataset.collapsed='0'; }); }

// =========================
// Rapport texte + compteurs
// =========================
const outTA = document.getElementById('reportOut');
const partsTA = document.getElementById('parts');
partsTA.addEventListener('input', ()=>{ state.parts = partsTA.value; saveState(); renderText(); });

function buildLines(nodes, depth=0, lines=[]){
  const indent = '  '.repeat(depth);
  nodes.forEach(nd=>{
    const mark = nd.checked ? '[x]' : '[ ]';
    const status = nd.level ? ` (${nd.level})` : '';
    lines.push(`${indent}- ${mark} ${nd.label}${status}`);
    if(nd.children?.length) buildLines(nd.children, depth+1, lines);
  });
  return lines;
}
function renderText(){
  const lines=[]; lines.push('RAPPORT D’ENTRETIEN – Checklist'); lines.push(''); lines.push('CHECKLIST:');
  buildLines(tree,0,lines); lines.push(''); lines.push('PIÈCES REMPLACÉES:');
  const ps = linesFromParts(); if(ps.length){ ps.forEach(p=>lines.push(` - ${p}`)); } else { lines.push('Aucune'); }
  lines.push(''); lines.push(`Généré le ${new Date().toLocaleString('fr-FR')}`);
  outTA.value = lines.join('\n');
  document.getElementById('counter').textContent = `${outTA.value.length} caractères`;
}
function linesFromParts(){ return lines(state.parts||''); }

function updateCounters(){
  let ok=0,w=0,b=0,all=0; (function walk(nodes){ nodes.forEach(nd=>{ all++; if(nd.level==='OK') ok++; else if(nd.level==='À surveiller') w++; else if(nd.level==='À corriger') b++; if(nd.children?.length) walk(nd.children); }); })(tree);
  document.getElementById('cntAll').textContent=all; document.getElementById('cntOk').textContent=ok; document.getElementById('cntWarn').textContent=w; document.getElementById('cntBad').textContent=b;
}

// =========================
// Copier / Reset
// =========================
async function copyReport(){
  const text = outTA.value;
  try{ if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(text); toast('Rapport copié (texte) ✔'); return; } }catch(e){}
  const ta=document.getElementById('scratch'); ta.value=text; ta.focus(); ta.select(); document.execCommand('copy'); toast('Rapport copié (texte) ✔');
}
function resetAll(){ if(!confirm('Réinitialiser la checklist et les pièces ?')) return; const base=lib.find(x=>x.id==='tpl_standard')||DEFAULT_TEMPLATES[0]; tree=clone(base.items); state.parts=''; state.lastTpl=base.id; saveState(); partsTA.value=''; renderTree(); }
function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',right:'16px',bottom:'16px',background:'var(--brand)',color:'#fff',padding:'10px 14px',borderRadius:'12px',boxShadow:'var(--shadow)',zIndex:9999}); document.body.appendChild(t); setTimeout(()=>t.remove(),1600); }

// =========================
// Export / Import JSON (modèles)
// =========================
function exportTemplates(){ const blob=new Blob([JSON.stringify(lib,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='checklist-templates.json'; document.body.appendChild(a); a.click(); a.remove(); }
function importTemplatesFromFile(file){ const fr=new FileReader(); fr.onload=()=>{ try{ const arr=JSON.parse(fr.result); if(!Array.isArray(arr)) throw new Error('Format invalide'); const names=new Set(lib.map(t=>t.name)); arr.forEach(t=>{ if(t?.name && t?.items){ const id='tpl_'+uid(); lib.push({ id, name: names.has(t.name)? t.name+' (import)':t.name, type:t.type||'Autre', items:t.items }); } }); saveTemplates(lib); refreshTemplateSelect(); alert('Modèles importés.'); }catch(err){ alert('Import impossible: '+err.message); } }; fr.readAsText(file,'utf-8'); }

// =========================
 // Sync GitHub (optionnel) — client-side via API
// =========================
const gh = {
  user: document.getElementById('ghUser'),
  repo: document.getElementById('ghRepo'),
  branch: document.getElementById('ghBranch'),
  path: document.getElementById('ghPath'),
  token: document.getElementById('ghToken'),
  remember: document.getElementById('rememberPat')
};
// restore PAT if remembered
try{ const savedPat = localStorage.getItem(STORAGE.pat); if(savedPat){ gh.token.value = atob(savedPat); gh.remember.checked = true; } }catch(e){}

gh.remember.addEventListener('change', ()=>{
  try{ if(gh.remember.checked){ localStorage.setItem(STORAGE.pat, btoa(gh.token.value||'')); } else { localStorage.removeItem(STORAGE.pat); } }catch(e){}
});

document.getElementById('pushGh').addEventListener('click', pushToGitHub);
document.getElementById('pullGh').addEventListener('click', pullFromGitHub);

async function pushToGitHub(){
  const {user,repo,branch,path,token} = valuesGh(); if(!token) return alert('Token requis');
  const url = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
  try{
    // get current SHA if exists
    let sha = undefined; let getRes = await fetch(url+`?ref=${encodeURIComponent(branch)}`, { headers: { Authorization: `Bearer ${token}` } });
    if(getRes.status===200){ const j=await getRes.json(); sha=j.sha; }
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(lib,null,2))));
    const body = { message:"Update templates.json from app", content, branch, sha };
    const res = await fetch(url, { method:'PUT', headers:{ Authorization:`Bearer ${token}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
    if(!res.ok){ const t = await res.text(); throw new Error(t); }
    toast('Modèles poussés sur GitHub ✔');
    if(gh.remember.checked){ try{ localStorage.setItem(STORAGE.pat, btoa(token)); }catch(e){} }
  }catch(err){ alert('Échec push: '+err.message); }
}
async function pullFromGitHub(){
  const {user,repo,branch,path,token} = valuesGh(); if(!token) return alert('Token requis');
  const url = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
  try{
    const res = await fetch(url, { headers:{ Authorization:`Bearer ${token}` }});
    if(!res.ok){ const t=await res.text(); throw new Error(t); }
    const j = await res.json();
    const decoded = JSON.parse(decodeURIComponent(escape(atob(j.content))));
    if(!Array.isArray(decoded)) throw new Error('Le fichier ne contient pas un tableau de modèles');
    lib = decoded; saveTemplates(lib); refreshTemplateSelect(); toast('Modèles récupérés ✔');
  }catch(err){ alert('Échec pull: '+err.message); }
}
function valuesGh(){ return { user:gh.user.value.trim(), repo:gh.repo.value.trim(), branch:gh.branch.value.trim(), path:gh.path.value.trim(), token:gh.token.value.trim() }; }

// =========================
// Init & events
// =========================
function init(){
  // hydrater PARTS
  document.getElementById('parts').value = state.parts || '';
  // UI modèles
  refreshTemplateSelect();
  // Arbre initial
  renderTree();
  // Boutons
  document.getElementById('applyTpl').addEventListener('click', ()=> applyTemplate(true));
  document.getElementById('appendTpl').addEventListener('click', ()=> applyTemplate(false));
  document.getElementById('saveTpl').addEventListener('click', saveTemplate);
  document.getElementById('deleteTpl').addEventListener('click', deleteTemplate);
  document.getElementById('exportBtn').addEventListener('click', exportTemplates);
  document.getElementById('importFile').addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) importTemplatesFromFile(f); e.target.value=''; });
  document.getElementById('copyBtn').addEventListener('click', copyReport);
  document.getElementById('resetBtn').addEventListener('click', resetAll);
  document.getElementById('expandAll').addEventListener('click', expandAll);
  document.getElementById('collapseAll').addEventListener('click', collapseAll);
}
init();
</script>
</body>
</html>
